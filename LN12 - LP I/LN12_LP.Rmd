---
title: "LN12 - 선형계획법(Linear Programming)"
Author : Dohyung Bang 
output: html_document
---

```{r "setup", include = FALSE}
knitr::opts_knit$set(root.dir = "C:/BA2021")
```

## `lpSolve`를 이용한 선형계획문제 해찾기

R을 이용한 선형계획법(Linear Programming : LP)은 `lpSolve` 패키지를 이용할 수 있다.

```{r}
install.packages("lpSolve")
```

```{r}
library(lpSolve)
```


### 1) 의사결정문제 정의

`lpSolve`를 이용해서 퇴근한 남편의 문제를 풀어보자.
아래와 같은 상황에서 남편의 효용(Utility)를 극대화하기 위해서 남편은
어떻게 시간을 배분해야 하겠는가?

```
퇴근하고 돌아온 남편은 저녁먹고 잠들기 전 4시간 동안 ‘게임’과 ‘아들과 놀아주기’를 할 수 있다. 남편은 아내와 다음의  두 가지 약속을 했다. 

  1) 게임을 하는 시간은 아들과 놀아주는 시간의 두 배를 넘을 수 없음
  2) 경험으로 볼 때, 아들과 놀아주는 심리적 피로는 게임에서 오는 피로의 4배 정도라고 하자. 게임을 한시간 하는데서
     오는 피로를 1이라고 할 때, 두 활동(게임, 아들과 놀아주기)에서 오는 피로의 합이 12가 넘지 않도록 함

그리고, 남편은 평소 아내의 반응을 통해 아들과 놀아주는 것이 게임하는 것보다 두 배로 유익하다는 것을 알고 있다. 
즉, 아들과 1시간 놀아주는 것이 게임 한시간 하는 것보다 얻는 효용이 두배라고 할 수 있다.
```

### 2) 목적함수 정의(Objective function)

`lpSolve`를 이용해 목적함수를 정의할 때는 목적함수의 계수만 vector로 정의한다.
`obj_fun`은 목적함수의 계수만 정의한 vector이다.

총 효용 = 1x게임하는 시간 + 2x놀아주는 시간
```{r}
obj_fun <- c(1, 2)
```


### 3) 제약조건(Constraints) 도출

`lpSolve`를 이용하기 위해서는 3가지를 별도로 정의해야 한다.

> 1) 제약조건에 들어있는 결정변수의 계수(상수)
> 2) 제약조건의 부등호 방향
> 3) 제약조건의 우변항(Right-hand side) 값

3가지 요소를 각각 `constr_coeff`, `constr_dir`, `constr_rhs`라는 이름으로 다음과 같이 정의해보자.
+ `constr_coeff`는 각 제약조건의 계수들만 따서 만든 행렬(matrix)로 정의된다.
+ `constr_dir`은 각 제약조건의 부등호 기호만 포함한 vector로 정의된다.
+ `constr_rhs`는 각 제약조건의 우변상수(Right-hand side) vector로 정의된다.

```{r}
constr_coeff <- matrix(c(1,1,1,
                         -2,1,4), 
                       ncol=2, byrow=TRUE)

constr_dir <- c("<=", "<=", "<=") # 제약조건의 방향 등호/부등호 
constr_rhs <- c(4, 0, 12) # 우변상수 벡터 
```

### 4) Solve the problem : 해 찾기

위에서 정의한 목적함수와 제약조건을 이용해 `lp()`함수를 써서 최적해(Optimal solution)을 구할 수 있다.
`lp()`함수 안에는 차례대로 
`최대화/최소화 여부, 목적함수, 제약조건 계수, 제약조건 부등호, 제약조건 우변상수`의 순으로 포함된다.

아래와 같이 수리모형을 `lp()`함수를 이용해 정의해보자. 
```{r}
husband_sol <- lp("max", 
                  obj_fun, 
                  constr_coeff, 
                  constr_dir, 
                  constr_rhs, 
                  compute.sens = TRUE)
```

분석된 결과를 살펴보자.

최적해(Solution)은 `$solution` 을 통해 알 수 있다. 
퇴근한 남편의 최적 시간배분은 게임에 `1.333 시간`, 아들과 놀아주기에 `2.667 시간`을 
배분하는 것이 최적의 시간배분이다. 
```{r}
husband_sol$solution
```

그럼, 최적해대로 의사결정했을 때, 남편이 얻는 효용의 극대값은 어떨까?
이는 목적함수의 각 의사결정변수에 최적해를 넣은 값 즉, 목적함수의 해이며, 
`$objval`를 통해 살펴보면 최적 효용은 6.667이다.
```{r}
husband_sol$objval
```

참고 - 의사결정 변수와 목적함수 값 관계
```
우리가 원하는 것은 목적함수를 극대화하는 최적 의사결정은 무엇인가 이지, 그 의사결정의 결과가 어떤가는 차순위의 문제이다. 위에서 효용이 6.667이라는 것은 우리가 임의로 정의한 목적함수의 최적값이지, 실제 6.667이 해석가능한 수치는 아니다. 

우리가 경영과학 기법에서 모형화 할 수 있는 이유는 주어진 상황 하에서 어떤 의사결정이 좋은 대안인가 선택하기만 하면 되는 것이지, 목적함수의 값이 얼마인지는 우선은 중요하지 않다. 
따라서, 효용함수를 단순히 x1 + 2x2 와 같이 임의의 수리모형으로 정의해도 되는 것이다. 

단, 좀 더 현실적인 문제를 모형화하기 위해서는 목적함수를 설정하는 문제가 매우 중요하다. 
특히, 정수계획문제에서는 목적함수를 정확히 설정하는 것이 매우 중요해진다. 
```

### 5) 쌍대문제(Dual problem)와 민감도(Sensitivity)

선형계획법은 목적함수와 제약식이 결정변수 간 1차 함수 즉, 선형관계 표현되어 `비례성`, `가합성`, `가분성`을 가정한다.

하지만, 현실문제에서 이러한 조건이 부합하지 않는 경우가 매우 많아 선형계획법의 해법이
현실문제를 반영하지 못한다는 한계를 지닌다.

이를 위해 선형계획문제를 풀고 난 후 민감도 분석(Sensitivity Analysis)을 실시하는 것이 
일반적이다. 민감도 분석을 하기 위해서는 먼저, 쌍대이론(Duality Theory)에 대한 이해가 필요하다.

**쌍대문제와 민감도 분석결과는 선형계획 문제에 보다 의미있는 경제적 정보를 제공해준다.**

---

#### ***쌍대이론(Duality Theory)***

원문제(원래 수립한 의사결정문제)를 그와 상대적인 측면에서 보면 또 다른 선형계획법
문제가 되는데, 이때, 상대적인 측면의 문제를 쌍대문제라 한다.

원문제가 "최대화(Maximization)"문제이면, 쌍대문제는 "최소화(Minimization" 문제가 된다.

다시, 퇴근한 남편의 문제를 살펴보자.
퇴근한 남편의 원 문제(Primal problem)에서 쌍대문제를 도출한 결과가 그림의 우측에 나타나 있다.

**원문제(primal problem) 쌍대문제(Dual problem) 관계**

+ ①번을 보면, 원 문제의 목적함수 계수가 쌍대문제에서는 제약조건 우변상수(RHS)가 된다.
+ ②,③번을 보면,  원 문제의 각 제약조건들이 행과 열이 전치(Transpose)되어 쌍대문제에서 제약조건으로 투입된다. 즉, 원 문제에서 각 제약조건은 2개의 결정변수로 이뤄져있으며, 3개의 제약조건이 주어지지만 쌍대문제에서는 각 제약조건은 3개의 결정변수로 이뤄져있고, 2개의 제약조건만 갖는다.
+ 마지막으로 ④번을 보면, 원 문제의 제약조건 우변상수가 쌍대문제에서는 목적함수의 계수가 된다.

![<그림 1> 원문제와 쌍대문제의 관계](C:/BA2021/figure/pri-dual_2.png)


이때, 쌍대문제의 결정변수를 잠재가격(Shadow Price)라고 표현하는데 잠재가격(쌍대변수)의 경제적
의미는 다음과 같다.

+ **자원 1단위의 증가 또는 감소가 원 문제 목적함수값에 미치는 영향. 자원의 한계가치 또는 기회비용** 
+ **자원이 일정한 양까지 증가할 때까지는 자원증가량에 비례해서 목적함수값이 증가함**

즉, 퇴근한 남편의 문제에서, 자원이 증가했다고 가정할 때, 이는 다음의 의미를 갖는다.

+ $y_{1}$ : 총 가용시간 제약의 완화; 4시간에서 `4+@시간`으로 완화
+ $y_{2}$ : 게임시간 제약의 완화; 게임시간이 아들과 놀아주는 시간의 2배넘을수 없다 에서 `2배+@`만큼으로 완화
+ $y_{3}$ : 총 피로도 제약의 완화; 총 피로도가 12에서 `12+@`로 완화


우선, 민감도 분석에서 목적함수 계수의 상/하한선을 구할 수 있다. 
```{r}
husband_sol$sens.coef.from
husband_sol$sens.coef.to
```

`lp()`함수의 아웃풋(output) 중에서 `duals`는 2가지 결과를 보여준다.

+ 첫번째는 쌍대변수의 한계가치 즉, 자원의 한계가치
+ 두번째는 목적함수에서 최적해가 1단위 증가할 때(가령, 게임시간 1시간 늘릴 때), 목적함수의 증가분

결과치는 순서대로 쌍대변수의 값과 목적함수의 증가분을 나타낸다.
아래 결과에서는 앞에 3개가 $y_{1}, y_{2}, y_{3}$을 나타내고, 뒤에 2개가 목적함수의 증가분을 나타낸다.

```{r}
husband_sol$duals
```

```{r}
husband_sol$duals.from
```

```{r}
husband_sol$duals.to
```


---

#### ***민감도 분석(Sensitivity analysis)*** 

앞서 살펴본 바와 같이 민감도(Sensitivity)는 선형계획법의 한계를 보완하기 위해 활용되는데
쌍대이론과 같이 잠재가격 즉, 자원의 변화에 따라 최적해가 얼마나 민감하게 달라지는지를 분석하는 것 외에도
모형을 수립할 초기와 달리 상황에 변화가 생겼을 경우 해가 어떻게 달라지는지에 대해 전반적으로 다루는 분석이다.

민감도 분석이 필요한 상황은 다음과 같다.

+ 1) 목적함수 계수가 변할때
+ 2) 제약조건 우변상수가 변할때
+ 3) 새로운 변수가 추가되었을때
+ 4) 새로운 제약조건이 추가되었을때

---

## 실습#2 : 제품믹스(Product Mix) 결정 문제

```
제품 A와 제품 B를 판매하는 기업이 있다.
1톤 생산하는 데 투입되는 노동시간은 제품 A는 30시간, 제품 B는 20시간이며,
한 달동안 투입되는 노동시간은 2,700시간을 넘으면 안된다.
또한, 1톤 생산 시 투입되는 장비 가동시간은 제품 A는 5시간, 제품 B는 10시간이며, 
한달동안 총 850시간 장비를 가동할 수 있다.

제품 A는 톤당 20 , 제품 B는 60의 이윤이 남으며, 기술적인 이유로 한달 동안 제품을 합쳐
최소 95톤은 생산해야 한다고 가정하자.

한달 동안 해당 기업이 취할 수 있는 이윤을 극대화하기 위해서는 A제품과 B제품을 각각 얼마나
생산하는 것이 최적인가?
```

### 1) 목적함수(Objective function)
```{r}
obj_fun <- c(20,60)
```


### 2) 제약조건(constraints)
```{r}
constr_coeff <- matrix(c(30,20,5,10,1,1), ncol=2, byrow=TRUE)
constr_dir <- c("<=", "<=", ">=")
constr_rhs <- c("2700", "850", "95")
```


### 3) 최적해 도출
```{r}
product_mix_sol <- lp("max", obj_fun, constr_coeff, constr_dir, constr_rhs, compute.sens = TRUE)
```


```
최적해는 A제품 20개, B제품 75개 생산했을 때, 이윤이 4900으로 최대가 됨
```
```{r}
product_mix_sol$solution
product_mix_sol$objval
```

### 4) 쌍대문제 및 민감도 분석
```
노동시간 한계가치는 0 즉, 노동시간에 대한 제약 완화는 목적함수에 영향없음
기계가동시간 한계가치는 8로 총 가용한 기계가동시간이 1시간 늘면, 최적 이윤은 8 증가
최소 생산량 제약의 한계가치는 -20으로 최소 생산량이 1톤 증가하면 최적 이윤은 20 감소 
```
```{r}
product_mix_sol$duals
```

---

## 실습#3 : 수송계획문제

![<그림 2> 수송계획문제](C:/BA2021/figure/transport.png)


### 1) 목적함수(Objective function)
```{r}
obj_fun <- c(8,6,3,2,4,9)
```


### 2) 제약조건(constraints)

```{r}
constr_coeff <- matrix(c(1,1,1,0,0,0,
                         0,0,0,1,1,1,
                         1,0,0,1,0,0,
                         0,1,0,0,1,0,
                         0,0,1,0,0,1), ncol=6, byrow = TRUE)
constr_dir <- c("<=","<=",">=",">=",">=")
constr_rhs <- c("70", "40", "40", "35", "25")
```


### 3) 최적해 도출
#### 최적해 도출
```{r}
transport_sol <- lp("min", obj_fun, constr_coeff, constr_dir, constr_rhs, compute.sens = TRUE)
```


#### 최적해 및 최대목적함수 값
```{r}
transport_sol$solution
transport_sol$objval
```


### 4) 쌍대문제 및 민감도 분석

```{r}
transport_sol$duals
```

---

## 실습#4 : 경제적 식단 관리 문제(Diet Problem)
  
![<그림 3> 경제적 식단 관리](C:/BA2021/figure/diet.png)


### 1) 목적함수(Objective function)
```{r}
obj_fun <- c(250,300,600,50)
```


### 2) 제약조건(constraints)
```{r}
constr_coeff <- matrix(c(70,350,420,30,
                         100,0,11,18,
                         3,6,20,2,
                         5,58,0,5), ncol=4, byrow = TRUE)
constr_dir <- c(">=",">=",">=",">=")
constr_rhs <- c("2500","700", "50", "400")
```


### 3) 최적해 도출
#### 최적해 도출
```{r}
diet_sol <- lp("min", obj_fun, constr_coeff, constr_dir, constr_rhs, compute.sens = TRUE)
```


#### 최적해 및 최대목적함수 값
```{r}
diet_sol$solution
diet_sol$objval
```


### 4) 쌍대문제 및 민감도 분석
```{r}
diet_sol$duals
```